left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by("{{levels[1]}}") %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by({{levels[1]}}) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by({{levels[1]}}) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by({{levels}}) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by({{levels}}) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by({{levels[[1]]}}) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by(levels[[1]]) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by(all_of(levels[[1]])) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by(all_of(levels[[1]])) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by(all_of(levels)) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by({levels}) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by({levels}) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by(x) %>%
summarise(pop = sum(Pop))
}
codepops %>%
group_by(.data$x) %>%
summarise(pop = sum(Pop))
}
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
map(levels,\(x){
codepops %>%
group_by(.data$x) %>%
summarise(pop = sum(Pop))
}
}
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
map(levels,\(x){
codepops %>%
group_by(.data$x) %>%
summarise(pop = sum(Pop))
})
}
test(GMelb_Popns, GMelb_Shapes)
codepops %>%
group_by(.data[[levels[2]]]) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
map(levels,\(x){
codepops %>%
group_by(.data[[levels[x]]]) %>%
summarise(pop = sum(Pop))
})
}
test(GMelb_Popns, GMelb_Shapes)
}
test(GMelb_Popns, GMelb_Shapes)
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
map(levels,\(x){
codepops %>%
group_by(.data[[levels[[x]]]) %>%
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
map(levels,\(x){
codepops %>%
group_by(.data[[levels[x]]]) %>%
summarise(pop = sum(Pop))
})
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by(.data[[levels[x]]]) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
popcodes <- list()
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
codepops %>%
group_by(.data[[levels[1]]]) %>%
summarise(pop = sum(Pop))
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes[i] <-  codepops %>%
group_by(.data[[levels[1]]]) %>%
summarise(pop = sum(Pop))
}
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[i]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[i]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
popcodes
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes$levels[i] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
popcodes
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i]]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
popcodes
}
test(GMelb_Popns, GMelb_Shapes)
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
popcodes
}
test(GMelb_Popns, GMelb_Shapes)
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(data[[levels[1]]],
data[[levels[1]]]))
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
for (i in 1:npatch){
patch_i <- data[i,]
norm <- rep(0, length(levels))
for (j in 1:npatch){
patch_j <- data[j,]
for (l in seq_along(levels)){ #find lowest level of association
code_l <-  levels[l]
if (patch_i[[code_l]] == patch_j[[code_l]]){
if (l == 1) mixmat[i,j] <- xi[1]
else{
mixmat[i,j] <- xi[l]*(popcodes[[l]][patch_j[[code_l]]] / popcodes[[l]][patch_i[[code_l]]] -popcodes[[l-1]][patch_i[[levels[l-1]]]])
}
}
}
}
}
mixmat
}
test(GMelb_Popns, GMelb_Shapes)
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(data[[levels[1]]],
data[[levels[1]]]))
levels[1]
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(codepops[[levels[1]]],
codepops[[levels[1]]]))
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
for (i in 1:npatch){
patch_i <- codepops[i,]
norm <- rep(0, length(levels))
for (j in 1:npatch){
patch_j <- codepops[j,]
for (l in seq_along(levels)){ #find lowest level of association
code_l <-  levels[l]
if (patch_i[[code_l]] == patch_j[[code_l]]){
if (l == 1) mixmat[i,j] <- xi[1]
else{
mixmat[i,j] <- xi[l]*(popcodes[[l]][patch_j[[code_l]]] / popcodes[[l]][patch_i[[code_l]]] -popcodes[[l-1]][patch_i[[levels[l-1]]]])
}
}
}
}
}
mixmat
}
test(GMelb_Popns, GMelb_Shapes)
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(codepops[[levels[1]]],
codepops[[levels[1]]]))
codepops[[levels[1]]]
codepops <- GMelb_Shapes[[1]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
codepops <- GMelb_Shapes[[3]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(codepops[[levels[1]]],
codepops[[levels[1]]]))
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
for (i in 1:npatch){
patch_i <- codepops[i,]
norm <- rep(0, length(levels))
for (j in 1:npatch){
patch_j <- codepops[j,]
for (l in seq_along(levels)){ #find lowest level of association
code_l <-  levels[l]
if (patch_i[[code_l]] == patch_j[[code_l]]){
if (l == 1) mixmat[i,j] <- xi[1]
else{
mixmat[i,j] <- xi[l]*(popcodes[[l]][patch_j[[code_l]]] / popcodes[[l]][patch_i[[code_l]]] -popcodes[[l-1]][patch_i[[levels[l-1]]]])
}
}
}
}
}
npatch = nrow(codepops)
npatch
for (i in 1:npatch){
patch_i <- codepops[i,]
norm <- rep(0, length(levels))
for (j in 1:npatch){
patch_j <- codepops[j,]
for (l in seq_along(levels)){ #find lowest level of association
code_l <-  levels[l]
if (patch_i[[code_l]] == patch_j[[code_l]]){
if (l == 1) mixmat[i,j] <- xi[1]
else{
mixmat[i,j] <- xi[l]*(popcodes[[l]][patch_j[[code_l]]] / popcodes[[l]][patch_i[[code_l]]] -popcodes[[l-1]][patch_i[[levels[l-1]]]])
}
}
}
}
}
codepops[i,]
levels[l]
patch_j[[code_l]]
patch_i[[code_l]]
l == 1
xi[1]
mixmat[i,j]
xi[l]
popcodes[[l]][patch_j[[code_l]]]
code_l
popcodes[[l]][[patch_j[[code_l]]]]
patch_j[[code_l]]
popcodes[[l]]
popcodes[[l]][patch_j[[code_l]],]
patch_j[[code_l]]
popcodes[[l]]
popcodes[l]
popcodes[l]
patch_j[[code_l]]
popcodes[l] %>%  filter(1 == patch_j[[code_l]])
popcodes[[l]] %>%  filter(1 == patch_j[[code_l]])
filter(code_l == patch_j[[code_l]])
popcodes[[l]] %>%  filter(code_l == patch_j[[code_l]])
popcodes[[l]]
code_l
popcodes[[l]] %>%  filter(.data[[code_l]] == patch_j[[code_l]])
ll_pop <-  popcodes[[l]] %>%  filter(.data[[code_l]] == patch_j[[code_l]]) %>% pluck(pop)
popcodes[[l]] %>%  filter(.data[[code_l]] == patch_j[[code_l]]) %>% pluck(2)
popcodes[[l-1]]
(popcodes[[l-1]] %>%  filter(.data[[levels[l-1]]] == patch_i[[levels[l-1]]]) %>% pluck(2))
(popcodes[[l]] %>%  filter(.data[[code_l]] == patch_i[[code_l]]) %>% pluck(2))
test <- function(GMelb_Popns, GMelb_Shapes){
codepops <- GMelb_Shapes[[3]] %>%
st_drop_geometry() %>%
select(ends_with("_CODE21")) %>%
left_join(GMelb_Popns[[1]], join_by(SA2_CODE21 == SA2_Code))
levels <- c(paste0("SA", c("2", "3", "4"), "_CODE21"), "GCC_CODE21")
xi <- rep(1/length(levels), length(levels))
npatch = nrow(codepops)
level_vec = vector("character", npatch)
mixmat = matrix(0, npatch, npatch,
dimnames = list(codepops[[levels[1]]],
codepops[[levels[1]]]))
popcodes <- list()
for (i in seq_along(levels)){
popcodes[[levels[i] %>% str_sub(1,3)]] <-  codepops %>%
group_by(.data[[levels[i]]]) %>%
summarise(pop = sum(Pop))
}
for (i in 1:npatch){
patch_i <- codepops[i,]
for (j in 1:npatch){
patch_j <- codepops[j,]
for (l in seq_along(levels)){ #find lowest level of association
code_l <-  levels[l]
if (patch_i[[code_l]] == patch_j[[code_l]]){
if (l == 1) mixmat[i,j] <- xi[1]
else{
ll_pop <-  popcodes[[l]] %>%  filter(.data[[code_l]] == patch_j[[code_l]]) %>% pluck(2)
ul_pop <- (popcodes[[l]] %>%  filter(.data[[code_l]] == patch_i[[code_l]]) %>% pluck(2)) - (popcodes[[l-1]] %>%  filter(.data[[levels[l-1]]] == patch_i[[levels[l-1]]]) %>% pluck(2))
mixmat[i,j] <- xi[l]*(ll_pop/ul_pop)
}
}
}
}
}
mixmat
}
test(GMelb_Popns, GMelb_Shapes)
